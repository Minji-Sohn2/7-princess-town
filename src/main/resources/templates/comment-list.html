<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸</title>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
            integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS"
            crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <link rel='stylesheet' href="/css/comment.css"/>

    <!-- ajax , cookies ì‚¬ìš© lib -->
</head>
<body>
<br/><br/><br/><br/><br/>
<!---start-comments-section--->
<div class="comment-section" style="padding:30px;">
    <div class="grids_of_2">
        <hr style="border-top: 1px solid #000;">
        <h2></h2>
        <div class="grids_of_2" id="comments">
        </div>
        <div class="artical-commentbox">
            <hr style="border-top: 1px solid #6c757d;">
            <h2 class="comment-h2" style="font-family: 'Jua', sans-serif">ëŒ“ê¸€</h2>
            <div class="table-form">
                <form name="post_comment">
                    <div>
                        <label style="font-family: 'Jua', sans-serif;">ë‹‰ë„¤ì„<span>*</span></label>
                        <h4 id="loginUserName">testid3</h4>
                    </div>
                    <div>
                        <label for="userComment" style="font-family: 'Jua', sans-serif;">ëŒ“ê¸€ì°½<span>*</span></label>
                        <textarea type="text" id="userComment" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </form>
                <button class="btn btn-secondary" type="button" onclick="insert()">ëŒ“ê¸€ ì‘ì„±</button>
            </div>
            <div class="clear" id="comment"></div>
        </div>
    </div>
</div>
        <nav aria-label="...">
            <ul class="pagination justify-content-center">
                <li class="page-item">
                    <a class="page-link prev-page-button" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item page-numbers">
                    <a class="page-link page-button active pagenumber"></a>
                </li>
                <li class="page-item">
                    <a class="page-link next-page-button" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
<!--<div class="pagination">-->
<!--    <button class="prev-page-button">ì´ì „</button>-->
<!--    <button class="next-page-button">ë‹¤ìŒ</button>-->
<!--    <span class="page-numbers">-->
<!--  </span>-->
<!--</div>-->

</body>
<script>
    // URLì—ì„œ postidë¥¼ ë½‘ì•„ëƒ„
    function getPostIdFromUrl() {
        const urlParts = window.location.pathname.split('/');
        const postIdIndex = urlParts.indexOf('posts') + 1;
        return urlParts[postIdIndex];
    }

    // í™”ë©´ì´ ë„ì›Œì§ˆê²½ìš° ì‹¤í–‰ë˜ëŠ” ë©”ì†Œë“œ
    $(document).ready(function () {
        const postId = getPostIdFromUrl();

        // í˜ì´ì§•
        const commentsContainer = $('.clear');
        const paginationContainer = $('.pagination');

        let currentPage = 0;
        let totalPages = 0;
        let startPage = 0;
        let endPage = 9;
        const pageSize = 10; // í˜ì´ì§€ë‹¹ ëŒ“ê¸€/ë‹µê¸€ ê°œìˆ˜

        // í˜ì´ì§€ ë¡œë“œì‹œ ëŒ“ê¸€ê³¼ ë‹µê¸€ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ í˜¸ì¶œ
        function loadCommentsAndReplies(page) {
            $.ajax({
                url: `/api/posts/${postId}/comments?page=${page}&size=${pageSize}`,
                method: 'GET',
                success: function(data) {
                    const comments = data.result.comments;
                    totalPages = data.result.paginationInfo.totalPages;
                    // console.log(comments)
                    // console.log(totalPages)
                    // console.log(page)
                    displayCommentsAndReplies(comments, page);
                    updatePagination(totalPages, page);
                }
            });
        }

        function displayCommentsAndReplies(comments, page) {
            console.log("í˜ì´ì§€ ë¡œë”©")
            // ì´ì „ì— í‘œì‹œëœ ëŒ“ê¸€ê³¼ ë‹µê¸€ ì œê±°
            commentsContainer.empty();

            $.ajax({
                url: `/api/posts/${postId}/comments?page=${page}&size=${pageSize}`,
                method: "GET",
                dataType: "json",
                success: function (comments) {
                    let data = comments.result.comments;
                    var commentsContainer = $("#comment");

                    // ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    $.ajax({
                        url: "/api/posts/" + postId + "/comments/likes",
                        method: "GET",
                        dataType: "json",
                        success: function (likesval) {
                            let likesData = likesval.result;
                            let usernames = "testid3";

                            data.forEach(function (comment) {

                                const createdAt = comment.createdAt;

                                const date = new Date(createdAt);

                                const formattedDate = date.toLocaleString("ko-KR", {
                                    year: "numeric",
                                    month: "2-digit",
                                    day: "2-digit",
                                    hour: "2-digit",
                                    minute: "2-digit",
                                    second: "2-digit",
                                });

                                // console.log(comment)

                                let temp_html = `
                                <div class="grid1_of_2" data-comment-id="${comment.id}">
                                <div class="grid_text">
                                    <hr style="border-top: 1px solid #6c757d;">
                                    <div class="grid_img">
                                        <img src="/img/20230812_215821.jpg" style="border-radius: 50%;">
                                    </div>
                                    <h4 class="style1 list" style="font-family: 'Jua', sans-serif;"><a href="#" style="font-family: 'Jua', sans-serif;">${comment.nickname}</a></h4>
                                    <p class="para top" style="font-family: 'Jua', sans-serif;" >${formattedDate}</p>
                                    <h5 class="style1 list">${comment.content}</h5>
                                    <br/>
                                    <a id="testid" class="btn1" style="font-family: 'Jua', sans-serif" data-comment-id="${comment.id}">ìˆ˜ì •</a>
                                    <a class="btn1" style="font-family: 'Jua', sans-serif" data-comment-id="${comment.id}">ì‚­ì œ</a>
                                    <a class="btn1 replyCreate" style="font-family: 'Jua', sans-serif">ë‹µê¸€ ë‹¬ê¸°</a>
                                    <a class="btn1 replyRead" style="font-family: 'Jua', sans-serif"  data-comment-id="${comment.id}" onclick="openReply(${comment.id})">ë‹µê¸€ í¼ì¹˜ê¸°  (0ê°œ)</a>
                                    <a class="btn1 replyClose" style="font-family: 'Jua', sans-serif; display: none" data-comment-id="${comment.id}" onclick="closeReply(${comment.id})">ë‹µê¸€ ë‹«ê¸°</a>
                                    <div>
                                        <a class="commentunLikes">ğŸ¤</a>
                                        <span>${comment.likeCnt}</span>
                                    </div>
                                </div>
                                <div class="grid_text userReply-Form" style="display: none">
                                    <label for="userReply" style="font-family: 'Jua', sans-serif;">ë‹µê¸€ì°½<span>*</span></label>
                                    <textarea type="text" id="userReply" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                                    <button class="btn btn-secondary" type="button" onclick="">ë‹µê¸€ ì‘ì„±</button>
                                </div>
                                <div class="grid_text userCommentEdit-Form" style="display: none">
                                    <label for="userCommentEdit" style="font-family: 'Jua', sans-serif;">ìˆ˜ì •ì°½<span>*</span></label>
                                    <textarea type="text" id="userReply" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                                    <button class="btn btn-secondary" type="button" onclick="">ëŒ“ê¸€ ìˆ˜ì •</button>
                                </div>

                            `

                                // í•´ë‹¹ ëŒ“ê¸€ì— ëŒ€í•œ ì¢‹ì•„ìš” ì •ë³´ ê²€ì‚¬
                                const likeInfo = likesData.find(function (like) {
                                    return like.comment_id === comment.id && like.username === usernames;
                                });

                                if (likeInfo && likeInfo.likes) {
                                    // console.log(likeInfo)
                                    temp_html = `
                                <div class="grid1_of_2" data-comment-id="${comment.id}">
                                <div class="grid_text">
                                    <hr style="border-top: 1px solid #6c757d;">
                                    <div class="grid_img">
                                        <img src="/img/20230812_215821.jpg" style="border-radius: 50%;">
                                    </div>
                                    <h4 class="style1 list" style="font-family: 'Jua', sans-serif;"><a href="#" style="font-family: 'Jua', sans-serif;">${comment.nickname}</a></h4>
                                    <p class="para top" style="font-family: 'Jua', sans-serif;" >${formattedDate}</p>
                                    <h5 class="style1 list">${comment.content}</h5>
                                    <br/>
                                    <a id="testid" class="btn1" style="font-family: 'Jua', sans-serif" data-comment-id="${comment.id}">ìˆ˜ì •</a>
                                    <a class="btn1" style="font-family: 'Jua', sans-serif" data-comment-id="${comment.id}">ì‚­ì œ</a>
                                    <a class="btn1 replyCreate" style="font-family: 'Jua', sans-serif">ë‹µê¸€ ë‹¬ê¸°</a>
                                    <a class="btn1 replyRead" style="font-family: 'Jua', sans-serif" data-comment-id="${comment.id}" onclick="openReply(${comment.id})">ë‹µê¸€ í¼ì¹˜ê¸° (0ê°œ)</a>
                                    <a class="btn1 replyClose" style="font-family: 'Jua', sans-serif; display: none" data-comment-id="${comment.id}" onclick="closeReply(${comment.id})">ë‹µê¸€ ë‹«ê¸°</a>
                                    <div>
                                        <a class="commentLikes">â¤ï¸</a>
                                        <span>${comment.likeCnt}</span>
                                    </div>
                                </div>
                                <div class="grid_text userReply-Form" style="display: none">
                                    <label for="userReply" style="font-family: 'Jua', sans-serif;">ë‹µê¸€ì°½<span>*</span></label>
                                    <textarea type="text" id="userReply" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                                    <button class="btn btn-secondary" type="button" onclick="">ë‹µê¸€ ì‘ì„±</button>
                                </div>
                                <div class="grid_text userCommentEdit-Form" style="display: none">
                                    <label for="userCommentEdit" style="font-family: 'Jua', sans-serif;">ìˆ˜ì •ì°½<span>*</span></label>
                                    <textarea type="text" id="userReply" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                                    <button class="btn btn-secondary" type="button" onclick="">ëŒ“ê¸€ ìˆ˜ì •</button>
                                </div>
                            `
                                }

                                let commentWrapper = $(`<div class="commentbox" data-comment-id="${comment.id}">${temp_html}</div>`);

                                // ë‹µê¸€ ê°€ì ¸ì˜¤ê¸°
                                $.ajax({
                                    url: "/api/posts/" + postId + "/comments/" + comment.id + "/reply",
                                    method: "GET",
                                    dataType: "json",
                                    success: function (replies) {
                                        let data2 = replies.result.replys;
                                        var repliesContainer = $('<div class="grid1_of_2 left" id="replyList" style="display: none"></div>');

                                        $.ajax({
                                            url: "/api/posts/" + postId + "/comments/" + comment.id + "/reply/likes",
                                            method: "GET",
                                            dataType: "json",
                                            success: function (replylikesval) {
                                                let replyLikesData = replylikesval.result;
                                                // console.log(replyLikesData)
                                                let usernames2 = "testid3";

                                                data2.forEach(function (reply) {
                                                    const createdAt = reply.createdAt;

                                                    const date = new Date(createdAt);

                                                    const formattedDate = date.toLocaleString("ko-KR", {
                                                        year: "numeric",
                                                        month: "2-digit",
                                                        day: "2-digit",
                                                        hour: "2-digit",
                                                        minute: "2-digit",
                                                        second: "2-digit",
                                                    });

                                                    let temp_html = `
                                                    <div  class="grid1_of_2 left" id="replyList" data-reply-id="${reply.id}">
                                                        <div class="grid_text">
                                                            <hr style="border-top: 1px solid #6c757d;">
                                                            <h4 class="style1 list" style="font-family: 'Jua', sans-serif;"><a href="#" style="font-family: 'Jua', sans-serif;" data-reply-id="${reply.id}">${reply.nickname}</a></h4>
                                                            <p class="para top" style="font-family: 'Jua', sans-serif;" data-reply-id="${reply.id}">${formattedDate}</p>
                                                            <h4 class="style1 list" data-reply-id="${reply.id}"> ${reply.content}</h4>
                                                            <div>
                                                                <a data-reply-id="${reply.id}">ğŸ¤</a>
                                                                <span data-reply-id="${reply.id}">${reply.likeCnt}</span>
                                                            </div>
                                                            <textarea type="text"  placeholder="ë‹µê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" style="display: none"/></textarea>
                                                            <button type="button" style="display: none">reply ìˆ˜ì •</button>
                                                            <a id="testid" class="btn1" style="font-family: 'Jua', sans-serif;">ìˆ˜ì •</a>
                                                            <a class="btn1" style="font-family: 'Jua', sans-serif;">ì‚­ì œ</a>
                                                        </div>
                                                        </div>
                                                `

                                                    // í•´ë‹¹ ëŒ“ê¸€ì— ëŒ€í•œ ì¢‹ì•„ìš” ì •ë³´ ê²€ì‚¬
                                                    var replylikeInfo = replyLikesData.find(function (replylike) {
                                                        return replylike.comment_id === comment.id && replylike.reply_id === reply.id && replylike.username === usernames2;
                                                    });

                                                    if (replylikeInfo && replylikeInfo.likes) {
                                                        temp_html = `
                                                    <div  class="grid1_of_2 left" id="replyList" data-reply-id="${reply.id}" style="display: none">
                                                        <div class="grid_text">
                                                            <hr style="border-top: 1px solid #6c757d;">
                                                            <h4 class="style1 list" style="font-family: 'Jua', sans-serif;"><a href="#" style="font-family: 'Jua', sans-serif;" data-reply-id="${reply.id}">${reply.nickname}</a></h4>
                                                            <p class="para top" style="font-family: 'Jua', sans-serif;" data-reply-id="${reply.id}">${formattedDate}</p>
                                                            <h4 class="style1 list" data-reply-id="${reply.id}"> ${reply.content}</h4>
                                                            <div>
                                                                <a id="replysLikes" data-reply-id="${reply.id}">â¤ï¸</a>
                                                                <span data-reply-id="${reply.id}">${reply.likeCnt}</span>
                                                            </div>
                                                            <textarea type="text"  placeholder="ë‹µê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" style="display: none"/></textarea>
                                                            <button type="button" style="display: none">reply ìˆ˜ì •</button>
                                                            <a id="testid" class="btn1" style="font-family: 'Jua', sans-serif;">ìˆ˜ì •</a>
                                                            <a class="btn1" style="font-family: 'Jua', sans-serif;">ì‚­ì œ</a>
                                                        </div>
                                                        </div>
                                                    `
                                                    }

                                                    // ê° ë‹µê¸€ì— ëŒ€í•œ ì¢‹ì•„ìš” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                                                    repliesContainer.append(temp_html);

                                                    // ë‹µê¸€ ê°¯ìˆ˜ êµ¬í•œí›„ í…ìŠ¤íŠ¸ ë³€í™˜
                                                    let replyCount = data2.length;
                                                    $(`.commentbox[data-comment-id="${comment.id}"] .replyRead`).text(`ë‹µê¸€ í¼ì¹˜ê¸° (${replyCount}ê°œ)`);
                                                })
                                            }
                                        });

                                        // ë‹µê¸€ì„ ëŒ“ê¸€ ì•„ë˜ì— ì¶”ê°€
                                        commentWrapper.append(repliesContainer);
                                    }
                                });

                                commentsContainer.append(commentWrapper);
                            });
                        }
                    });
                }
            });
        }

        function updatePageButtons() {
            const pageNumbersContainer = paginationContainer.find('.page-numbers');
            pageNumbersContainer.empty();

            const maxPage = Math.min(totalPages, endPage + 1); // ì‹¤ì œ ë°ì´í„°ê°€ ìˆëŠ” í˜ì´ì§€ê¹Œì§€ë§Œ ìƒì„±

            for (let i = startPage; i < maxPage; i++) {
                const pageNumber = i + 1; // í˜ì´ì§€ ë²ˆí˜¸ëŠ” 1ë¶€í„° ì‹œì‘
                const activeClass = i === currentPage ? 'active' : '';
                const pageButton = `<li class="page-item page-numbers list-inline-item" style="margin-right: 0">
                                <a class="page-link page-button ${activeClass} pagenumber" data-page="${i}">
                                    ${pageNumber}
                                </a>
                            </li>`;
                pageNumbersContainer.append(pageButton);
            }
        }

        function updatePagination() {
            updatePageButtons();
            paginationContainer.find('.prev-page-button').toggleClass('disabled', currentPage === 0);
            paginationContainer.find('.next-page-button').toggleClass('disabled', currentPage === totalPages - 1);
        }

        // ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ
        updatePagination();
        loadCommentsAndReplies(currentPage);

        // í˜ì´ì§€ ë²ˆí˜¸ í´ë¦­ ì‹œ í•´ë‹¹ í˜ì´ì§€ ëŒ“ê¸€/ë‹µê¸€ ê°€ì ¸ì˜¤ê¸°
        $('.pagination').on('click', '.pagenumber', function() {
            const page = parseInt($(this).data('page'));
            currentPage = page; // í™œì„±í™”ëœ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì—…ë°ì´íŠ¸
            updatePagination();
            loadCommentsAndReplies(page);
        });

        // ì´ì „ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ì „ í˜ì´ì§€ ëŒ“ê¸€/ë‹µê¸€ ê°€ì ¸ì˜¤ê¸°
        $('.prev-page-button').click(function() {
            if (currentPage > 0) {
                if(currentPage < 1) {
                    currentPage -= pageSize;
                } else {
                        currentPage = currentPage.toString().slice(0, -1) * 10 - pageSize;
                        console.log(currentPage)
                    }
                if (currentPage < startPage) {
                    startPage -= 10;
                    endPage -= 10;
                }
                updatePagination();
                loadCommentsAndReplies(currentPage);
            }
        });

// ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ìŒ í˜ì´ì§€ ëŒ“ê¸€/ë‹µê¸€ ê°€ì ¸ì˜¤ê¸°
        $('.next-page-button').click(function() {
            if (currentPage < totalPages - 1) {
                if(currentPage < 1) {
                    currentPage += pageSize;
                    // console.log(currentPage)
                } else {
                    currentPage = currentPage.toString().slice(0, -1) * 10 + pageSize;
                    // console.log(currentPage)
                }
                if (currentPage > endPage) {
                    startPage += 10;
                    endPage += 10;
                }
                updatePagination();
                loadCommentsAndReplies(currentPage);
            }
        });
    });

    function openReply(commentId) {
        $(`.commentbox[data-comment-id="${commentId}"] #replyList`).show();
        $(`.commentbox[data-comment-id="${commentId}"] .replyRead`).hide();
        $(`.commentbox[data-comment-id="${commentId}"] .replyClose`).show();
    }

    function closeReply(commentId) {
        $(`.commentbox[data-comment-id="${commentId}"] #replyList`).hide();
        $(`.commentbox[data-comment-id="${commentId}"] .replyRead`).show();
        $(`.commentbox[data-comment-id="${commentId}"] .replyClose`).hide();
    }
</script>
</html>
